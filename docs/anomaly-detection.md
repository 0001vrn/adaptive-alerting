# Anomaly detection

## Overview

Adaptive Alerting (AA) is primarily concerned with streaming time series anomaly detection. The
idea is that we have various incoming time series, and each one is being generated by some
underlying data generating process. We monitor each time series in real time to look for evidence
that the underlying process has changed in some way. Usually we look for outliers in the data.

Outliers are only a proxy for anomalies, though, and as such they provide only indirect
evidence. Most data generating processes involve some level of noise, including noise arising
from [sampling error](https://en.wikipedia.org/wiki/Sampling_error)). Occasionally the noise is
large enough that it looks an anomaly has kicked in even though it hasn't. It's also possible
for an actual anomaly to be small enough that its effect isn't strongly distinguishable from
noise. In general there's no bright line between noise and anomalies, and so using outliers for
anomaly detection involves a fundamental tradeoff between capturing all anomalies and capturing
only anomalies. Put another way, there's a tradeoff between avoiding false negatives and
avoiding false positives. 

![Normal data, noise and anomalies](images/normal-noise-anomaly.png)

(Adapted from a figure in _Outlier Analysis_ by Charu C. Aggarwal.)

Still, reducing anomaly detection to outlier detection is useful because there are many
algorithms available that do a good job of balancing false positives and negatives in a
reasonable way. More sophisticated approaches can treat outlier detection as the first pass
and then use a follow-up diagnostic/verification pass to determine whether the anomaly is real.

## Outlier detection for a given time series

How do we process a given time series for outliers?

One key point is there isn't a universal outlier detector that works across all time series.
A fixed-threshold will work for a time series whose values are mostly constant, but not for a
time series with daily, weekly and annual seasonalities. So when we receive a time series value,
we have to find the right detector for that time series and then apply it.

"Finding the right detector" involves more than knowing the model family (e.g., constant
threshold, EWMA, PEWMA, Aquila, etc.). We also have to know its specific parameters. For
example, there can be multiple time series using an EWMA model, but one will have the mean
parameter set to 92 while another has the mean parameter set to 14. Or to take another example
from Expedia, say we're using Aquila models to do outlier detection for bookings. We fit these
in advance, and the model for expedia.com hotels bookings is distinct from the model for
expedia.co.uk cars bookings.

What this means is that for any given time series value, we go through the following process:

- Identify the time series to which it belongs.
- Based on the given time series, identify its _instantiated model_ (that is, a model that has
  already been fit to the data)
- Evaluate the time series value against that instantiated model.


